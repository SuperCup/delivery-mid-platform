<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG-222294到家结算流程 - 结算管理追踪系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            left: -4px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e5e7eb;
        }
        .timeline-item.completed::after {
            background-color: #10B981;
        }
        .timeline-item.current::after {
            background-color: #3B82F6;
        }
        .timeline-item:hover {
            transform: translateX(4px);
            transition: transform 0.2s ease;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 0.5rem;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .file-item {
            transition: all 0.2s ease;
        }
        .file-item:hover {
            background-color: #f3f4f6;
        }
        body {
            min-width: 1920px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 顶部导航栏 -->
    <div class="w-[1920px] h-[80px] bg-white border-b border-gray-200 fixed top-0 left-0 z-50">
        <div class="h-full px-6 flex items-center justify-between">
            <span class="text-[#FF673C] text-xl font-bold">业务中台</span>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-gray-500"></i>
                </div>
                <span class="text-gray-600">管理员</span>
            </div>
        </div>
    </div>

    <!-- 左侧菜单栏 -->
    <div class="fixed left-0 top-[80px] w-[254px] h-[calc(100vh-80px)] bg-white border-r border-gray-200 overflow-y-auto">
        <!-- 菜单列表 -->
        <nav class="mt-4">
            <a href="data-files.html" class="flex items-center h-[60px] px-6 text-gray-600 hover:bg-[#D7E5FF] hover:text-[#005EFF]">
                <i class="fas fa-database w-5"></i>
                <span class="ml-3">数据文件</span>
            </a>
            <a href="documents.html" class="flex items-center h-[60px] px-6 text-gray-600 hover:bg-[#D7E5FF] hover:text-[#005EFF]">
                <i class="fas fa-file-alt w-5"></i>
                <span class="ml-3">文件文档</span>
            </a>
            <a href="account.html" class="flex items-center h-[60px] px-6 text-gray-600 hover:bg-[#D7E5FF] hover:text-[#005EFF]">
                <i class="fas fa-user-cog w-5"></i>
                <span class="ml-3">账号管理</span>
            </a>
            <a href="ai-knowledge.html" class="flex items-center h-[60px] px-6 text-gray-600 hover:bg-[#D7E5FF] hover:text-[#005EFF]">
                <i class="fas fa-brain w-5"></i>
                <span class="ml-3">AI知识库</span>
            </a>
            <div class="space-y-1">
                <div class="flex items-center h-[60px] px-6 bg-[#D7E5FF] text-[#005EFF]">
                    <i class="fas fa-tasks w-5"></i>
                    <span class="ml-3">结算跟进</span>
                </div>
                <div class="space-y-1">
                    <a href="settlement-step.html" class="flex items-center h-[60px] px-6 pl-8 text-gray-600 hover:bg-[#D7E5FF] hover:text-[#005EFF]">
                        <i class="fas fa-plus w-5"></i>
                        <span class="ml-3">新建环节</span>
                    </a>
                    <a href="settlement-list.html" class="flex items-center h-[60px] px-6 pl-8 bg-[#D7E5FF] text-[#005EFF]">
                        <i class="fas fa-chart-line w-5"></i>
                        <span class="ml-3">结算进度</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>

    <!-- 客户选择区域 -->
    <div class="fixed left-[254px] top-[80px] w-[354px] h-[calc(100vh-80px)] overflow-y-auto">
        <div class="pt-6 px-[25px]">
            <h1 class="text-xl font-bold text-gray-900 mb-6">结算跟进</h1>
            <div class="flex items-center space-x-4 mb-4">
                <!-- 搜索框 -->
                <div class="relative flex-1">
                    <input type="text" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="搜索客户">
                    <div class="absolute left-3 top-2.5 text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <!-- 年份选择 -->
                <select class="border border-gray-300 rounded-md text-sm px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option>2024</option>
                    <option>2025</option>
                </select>
            </div>
            
            <!-- 客户卡片列表 -->
            <div class="space-y-3">
                <!-- 客户1 -->
                <div class="w-[304px] h-[64px] bg-white rounded-lg shadow hover:shadow-md cursor-pointer transition-all duration-200 p-4 flex items-center justify-between group hover:bg-[#D7E5FF]">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 font-medium">A</span>
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900 group-hover:text-[#005EFF]">阿里巴巴</div>
                            <div class="text-xs text-gray-500">3个进行中的项目</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-[#005EFF]"></i>
                </div>

                <!-- 客户2 -->
                <div class="w-[304px] h-[64px] bg-[#D7E5FF] rounded-lg shadow cursor-pointer transition-all duration-200 p-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 font-medium">T</span>
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-[#005EFF]">腾讯科技</div>
                            <div class="text-xs text-gray-500">2个进行中的项目</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-[#005EFF]"></i>
                </div>

                <!-- 客户3 -->
                <div class="w-[304px] h-[64px] bg-white rounded-lg shadow hover:shadow-md cursor-pointer transition-all duration-200 p-4 flex items-center justify-between group hover:bg-[#D7E5FF]">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-blue-600 font-medium">B</span>
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900 group-hover:text-[#005EFF]">百度在线</div>
                            <div class="text-xs text-gray-500">1个进行中的项目</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-[#005EFF]"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="ml-[608px] pt-[80px]">
        <div class="p-6">
            <!-- 白色背景容器 -->
            <div class="w-[1292px] bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-6 overflow-y-auto max-h-[calc(100vh-80px-48px)]">
                    <!-- 流程概览卡片 -->
                    <div class="bg-white shadow rounded-lg mb-6">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="flex items-center">
                                        <h3 class="text-lg font-medium text-gray-900">到家结算流程</h3>
                                        <span class="ml-2 text-sm text-blue-600">品牌A</span>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-500">项目编号: SG-222294</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500">预计完成时间</p>
                                        <p class="text-sm font-medium text-gray-900">2024-03-25</p>
                                    </div>
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        进行中
                                    </span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="relative pt-1">
                                    <div class="flex mb-2 items-center justify-between">
                                        <div>
                                            <span class="text-xs font-semibold inline-block text-blue-600">
                                                进度
                                            </span>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-xs font-semibold inline-block text-blue-600">
                                                60%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
                                        <div style="width:60%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button id="sendConfirmationBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-envelope mr-2"></i>
                                    发送结算确认
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 时间线 -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">流程进度</h3>
                            <div class="space-y-6">
                                <!-- 已完成环节 -->
                                <div class="timeline-item completed">
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-file-invoice text-green-500"></i>
                                                <span class="ml-2 text-sm font-medium text-gray-900">发票审核</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs text-green-600">已完成</span>
                                                <span class="text-xs text-gray-500">周期: 3天</span>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-sm text-gray-500">
                                            <p>负责人: 张三</p>
                                            <p>开始时间: 2024-03-15 10:00</p>
                                            <p>完成时间: 2024-03-15 14:30</p>
                                        </div>
                                        <!-- 文件管理区域 -->
                                        <div class="mt-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="text-sm font-medium text-gray-700">已上传文件</h4>
                                            </div>
                                            <div class="file-list space-y-2">
                                                <div class="file-item flex items-center justify-between p-2 rounded-md bg-white">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                                                        <span class="text-sm text-gray-700">发票扫描件.pdf</span>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <button class="text-blue-600 hover:text-blue-700" onclick="previewFile('发票扫描件.pdf')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="text-blue-600 hover:text-blue-700" onclick="downloadFile('发票扫描件.pdf')">
                                                            <i class="fas fa-download"></i>
                                                        </button>
                                                        <button class="text-red-600 hover:text-red-700" onclick="confirmDeleteFile('发票扫描件.pdf', this)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 当前环节 -->
                                <div class="timeline-item current">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-file-contract text-blue-500"></i>
                                                <span class="ml-2 text-sm font-medium text-gray-900">合同确认</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs text-blue-600">进行中</span>
                                                <span class="text-xs text-gray-500">周期: 2天</span>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-sm text-gray-500">
                                            <p>负责人: 李四</p>
                                            <p>开始时间: 2024-03-15 15:00</p>
                                            <p>预计完成: 2024-03-17 15:00</p>
                                        </div>
                                        <!-- 文件管理区域 -->
                                        <div class="mt-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="text-sm font-medium text-gray-700">已上传文件</h4>
                                                <button class="text-sm text-blue-600 hover:text-blue-700" onclick="openUploadModal('合同确认')">
                                                    <i class="fas fa-upload mr-1"></i>上传文件
                                                </button>
                                            </div>
                                            <div class="file-list space-y-2">
                                                <div class="file-item flex items-center justify-between p-2 rounded-md bg-white">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-file-word text-blue-500 mr-2"></i>
                                                        <span class="text-sm text-gray-700">合同草案.docx</span>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <button class="text-blue-600 hover:text-blue-700" onclick="previewFile('合同草案.docx')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="text-blue-600 hover:text-blue-700" onclick="downloadFile('合同草案.docx')">
                                                            <i class="fas fa-download"></i>
                                                        </button>
                                                        <button class="text-red-600 hover:text-red-700" onclick="confirmDeleteFile('合同草案.docx', this)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <button class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                                <i class="fas fa-check mr-2"></i>
                                                完成任务
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 待处理环节 -->
                                <div class="timeline-item">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-file-signature text-gray-400"></i>
                                                <span class="ml-2 text-sm font-medium text-gray-900">签字盖章</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-xs text-gray-500">待处理</span>
                                                <span class="text-xs text-gray-500">周期: 1天</span>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-sm text-gray-500">
                                            <p>负责人: 王五</p>
                                            <p>预计开始: 2024-03-17 15:00</p>
                                            <p>预计完成: 2024-03-18 15:00</p>
                                        </div>
                                        <!-- 文件管理区域 -->
                                        <div class="mt-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h4 class="text-sm font-medium text-gray-700">已上传文件</h4>
                                                <button class="text-sm text-blue-600 hover:text-blue-700" onclick="openUploadModal('签字盖章')">
                                                    <i class="fas fa-upload mr-1"></i>上传文件
                                                </button>
                                            </div>
                                            <div class="file-list space-y-2">
                                                <!-- 暂无文件时显示提示 -->
                                                <div class="text-center py-4 text-sm text-gray-500">
                                                    <i class="fas fa-folder-open mb-2"></i>
                                                    <p>暂无文件</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 通知区域 -->
                    <div class="mt-6 bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">通知与提醒</h3>
                            <div class="space-y-4">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-bell text-yellow-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-gray-900">合同确认环节即将到期</p>
                                        <p class="text-xs text-gray-500">剩余时间: 2小时</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-gray-900">新的文件已上传</p>
                                        <p class="text-xs text-gray-500">请及时查看和处理</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 结算确认邮件历史 -->
                    <div class="mt-6 bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">结算确认邮件历史</h3>
                            <div class="space-y-4" id="emailHistory">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-envelope text-green-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-gray-900">结算确认邮件已发送</p>
                                        <p class="text-xs text-gray-500">收件人: finance@example.com, manager@example.com</p>
                                        <p class="text-xs text-gray-500">发送时间: 2024-03-10 14:30</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 发送结算确认邮件模态框 -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">发送结算确认邮件</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label for="recipients" class="block text-sm font-medium text-gray-700">收件人邮箱</label>
                <div class="mt-1">
                    <textarea id="recipients" rows="3" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md" placeholder="请输入收件人邮箱，多个邮箱请用逗号分隔"></textarea>
                </div>
                <p class="mt-1 text-xs text-gray-500">多个邮箱请用逗号分隔</p>
            </div>
            <div class="mb-4">
                <label for="message" class="block text-sm font-medium text-gray-700">邮件内容</label>
                <div class="mt-1">
                    <textarea id="message" rows="4" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">您好，SG-222294到家结算流程已完成，请确认。如有问题，请及时反馈。</textarea>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">发送时间</label>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center">
                        <input id="sendNow" name="sendTime" type="radio" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300" checked>
                        <label for="sendNow" class="ml-2 block text-sm text-gray-700">立即发送</label>
                    </div>
                    <div class="flex items-center">
                        <input id="scheduleSend" name="sendTime" type="radio" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                        <label for="scheduleSend" class="ml-2 block text-sm text-gray-700">定时发送</label>
                    </div>
                    <div id="scheduleTimeContainer" class="ml-6 mt-2 hidden">
                        <input type="datetime-local" id="scheduleTime" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
            <div class="flex justify-end">
                <button id="cancelSend" class="mr-3 inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    取消
                </button>
                <button id="sendEmail" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-paper-plane mr-2"></i>
                    发送
                </button>
            </div>
        </div>
    </div>

    <!-- 添加文件上传模态框 -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">上传文件</h3>
                <button id="closeUploadModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label for="fileUpload" class="block text-sm font-medium text-gray-700">选择文件</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                        <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl"></i>
                        <div class="flex text-sm text-gray-600">
                            <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                <span>上传文件</span>
                                <input id="file-upload" name="file-upload" type="file" class="sr-only">
                            </label>
                            <p class="pl-1">或拖拽文件到此处</p>
                        </div>
                        <p class="text-xs text-gray-500">支持 PDF, DOC, DOCX, XLS, XLSX, JPG, PNG 格式</p>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label for="fileDescription" class="block text-sm font-medium text-gray-700">文件说明</label>
                <div class="mt-1">
                    <textarea id="fileDescription" rows="3" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md" placeholder="请输入文件说明"></textarea>
                </div>
            </div>
            <div class="flex justify-end">
                <button id="cancelUpload" class="mr-3 inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    取消
                </button>
                <button id="confirmUpload" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-upload mr-2"></i>
                    上传
                </button>
            </div>
        </div>
    </div>

    <!-- 添加文件删除确认模态框 -->
    <div id="deleteFileModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">确认删除</h3>
                <button id="closeDeleteModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-700">确定要删除文件 <span id="fileNameToDelete" class="font-medium"></span> 吗？此操作不可恢复。</p>
            </div>
            <div class="flex justify-end">
                <button id="cancelDelete" class="mr-3 inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    取消
                </button>
                <button id="confirmDelete" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">
                    <i class="fas fa-trash mr-2"></i>
                    删除
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const sendConfirmationBtn = document.getElementById('sendConfirmationBtn');
            const confirmationModal = document.getElementById('confirmationModal');
            const closeModal = document.getElementById('closeModal');
            const cancelSend = document.getElementById('cancelSend');
            const sendEmail = document.getElementById('sendEmail');
            const emailHistory = document.getElementById('emailHistory');

            // 检查流程是否完成
            function checkProcessCompletion() {
                const totalSteps = document.querySelectorAll('.timeline-item').length;
                const completedSteps = document.querySelectorAll('.timeline-item.completed').length;
                const allStepsCompleted = completedSteps === totalSteps;
                
                console.log('流程完成检查:', {
                    totalSteps,
                    completedSteps,
                    allStepsCompleted
                });
                
                // 更新按钮状态
                sendConfirmationBtn.disabled = !allStepsCompleted;
                
                // 添加视觉反馈
                if (allStepsCompleted) {
                    sendConfirmationBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    sendConfirmationBtn.classList.add('hover:bg-blue-700');
                } else {
                    sendConfirmationBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    sendConfirmationBtn.classList.remove('hover:bg-blue-700');
                }
            }

            // 初始化检查
            checkProcessCompletion();

            // 监听环节状态变化
            document.querySelectorAll('.timeline-item').forEach(item => {
                // 这里可以添加环节状态变化的监听
                // 当环节完成时，重新检查整体状态
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            checkProcessCompletion();
                        }
                    });
                });
                
                observer.observe(item, { attributes: true });
            });

            // 打开模态框
            sendConfirmationBtn.addEventListener('click', function() {
                confirmationModal.style.display = 'block';
            });

            // 关闭模态框
            closeModal.addEventListener('click', function() {
                confirmationModal.style.display = 'none';
            });

            // 取消发送
            cancelSend.addEventListener('click', function() {
                confirmationModal.style.display = 'none';
            });

            // 发送邮件
            sendEmail.addEventListener('click', function() {
                const recipients = document.getElementById('recipients').value;
                const message = document.getElementById('message').value;
                const sendNow = document.getElementById('sendNow').checked;
                const scheduleTime = document.getElementById('scheduleTime').value;
                
                if (!recipients) {
                    alert('请输入收件人邮箱');
                    return;
                }
                
                if (!sendNow && !scheduleTime) {
                    alert('请选择发送时间');
                    return;
                }
                
                // 这里应该是发送邮件的API调用
                console.log('发送邮件:', {
                    recipients,
                    message,
                    sendTime: sendNow ? '立即发送' : scheduleTime
                });
                
                // 添加发送记录
                const now = new Date();
                const formattedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                const historyItem = document.createElement('div');
                historyItem.className = 'flex items-start';
                historyItem.innerHTML = `
                    <div class="flex-shrink-0">
                        <i class="fas fa-envelope text-green-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900">结算确认邮件已发送</p>
                        <p class="text-xs text-gray-500">收件人: ${recipients}</p>
                        <p class="text-xs text-gray-500">发送时间: ${sendNow ? '立即发送' : scheduleTime}</p>
                    </div>
                `;
                
                emailHistory.insertBefore(historyItem, emailHistory.firstChild);
                
                // 关闭模态框
                confirmationModal.style.display = 'none';
                
                // 显示成功提示
                alert('结算确认邮件已发送成功！');
            });

            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target === confirmationModal) {
                    confirmationModal.style.display = 'none';
                }
            });

            // 完成任务按钮点击事件
            document.querySelectorAll('.timeline-item.current button').forEach(button => {
                button.addEventListener('click', function() {
                    completeCurrentStep(this.closest('.timeline-item'));
                });
            });

            // 完成当前环节
            function completeCurrentStep(currentStep) {
                // 更新当前环节状态
                currentStep.classList.remove('current');
                currentStep.classList.add('completed');
                
                // 更新环节内容
                const stepContent = currentStep.querySelector('.bg-blue-50');
                stepContent.classList.remove('bg-blue-50');
                stepContent.classList.add('bg-green-50');
                
                // 更新状态标签
                const statusLabel = stepContent.querySelector('.text-blue-600');
                statusLabel.classList.remove('text-blue-600');
                statusLabel.classList.add('text-green-600');
                statusLabel.textContent = '已完成';
                
                // 更新图标颜色
                const icon = stepContent.querySelector('.text-blue-500');
                icon.classList.remove('text-blue-500');
                icon.classList.add('text-green-500');
                
                // 只移除完成任务按钮
                const buttons = stepContent.querySelectorAll('button');
                buttons.forEach(button => {
                    if (button.textContent.includes('完成任务')) {
                        button.closest('.mt-4').remove();
                    }
                });
                
                // 激活下一个环节
                activateNextStep(currentStep);
                
                // 更新进度
                updateProgress();
                
                // 检查流程完成状态
                checkProcessCompletion();
                
                // 显示完成提示
                alert('环节已完成！');
            }

            // 激活下一个环节
            function activateNextStep(currentStep) {
                const nextStep = currentStep.nextElementSibling;
                if (nextStep && nextStep.classList.contains('timeline-item')) {
                    // 更新下一个环节状态
                    nextStep.classList.add('current');
                    
                    // 更新环节内容
                    const stepContent = nextStep.querySelector('.bg-gray-50');
                    stepContent.classList.remove('bg-gray-50');
                    stepContent.classList.add('bg-blue-50');
                    
                    // 更新状态标签
                    const statusLabel = stepContent.querySelector('.text-gray-500');
                    statusLabel.classList.remove('text-gray-500');
                    statusLabel.classList.add('text-blue-600');
                    statusLabel.textContent = '进行中';
                    
                    // 更新图标颜色
                    const icon = stepContent.querySelector('.text-gray-400');
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-blue-500');
                    
                    // 添加完成任务按钮
                    const detailsContainer = stepContent.querySelector('.mt-2');
                    if (detailsContainer) {
                        // 创建按钮容器
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'mt-4';
                        
                        // 创建按钮
                        const button = document.createElement('button');
                        button.className = 'inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700';
                        button.innerHTML = '<i class="fas fa-check mr-2"></i>完成任务';
                        
                        // 添加点击事件
                        button.addEventListener('click', function() {
                            completeCurrentStep(nextStep);
                        });
                        
                        // 将按钮添加到容器
                        buttonContainer.appendChild(button);
                        
                        // 将按钮容器添加到环节内容中
                        stepContent.appendChild(buttonContainer);
                    }
                }
            }

            // 添加手动切换环节状态的功能（用于测试）
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.addEventListener('dblclick', function() {
                    if (!this.classList.contains('completed')) {
                        completeCurrentStep(this);
                    }
                });
            });

            // 更新进度条
            function updateProgress() {
                const totalSteps = document.querySelectorAll('.timeline-item').length;
                const completedSteps = document.querySelectorAll('.timeline-item.completed').length;
                const progress = (completedSteps / totalSteps) * 100;
                
                console.log('进度计算:', {
                    totalSteps,
                    completedSteps,
                    progress
                });
                
                // 更新进度条
                const progressBar = document.querySelector('.progress-bar');
                progressBar.style.width = `${progress}%`;
                
                // 更新进度文本
                const progressText = document.querySelector('.text-xs.font-semibold.inline-block.text-blue-600:last-child');
                progressText.textContent = `${Math.round(progress)}%`;
                
                // 更新进度数字
                const progressCount = document.querySelector('.text-sm.text-gray-500');
                progressCount.textContent = `${completedSteps}/${totalSteps}`;
                
                // 如果所有环节都完成，更新状态标签
                if (completedSteps === totalSteps) {
                    const statusSpan = document.querySelector('.inline-flex.items-center.px-3.py-1.rounded-full.text-sm.font-medium');
                    statusSpan.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
                    statusSpan.innerHTML = '<i class="fas fa-check-circle mr-2"></i>已完成';
                }
            }

            // 文件上传相关功能
            function openUploadModal(stepName) {
                const modal = document.getElementById('uploadModal');
                modal.style.display = 'block';
                // 可以在这里设置当前环节名称
                document.querySelector('#uploadModal h3').textContent = `上传文件 - ${stepName}`;
            }

            // 关闭上传模态框
            document.getElementById('closeUploadModal').addEventListener('click', function() {
                document.getElementById('uploadModal').style.display = 'none';
            });

            document.getElementById('cancelUpload').addEventListener('click', function() {
                document.getElementById('uploadModal').style.display = 'none';
            });

            // 处理文件上传
            document.getElementById('confirmUpload').addEventListener('click', function() {
                const fileInput = document.getElementById('file-upload');
                const description = document.getElementById('fileDescription').value;
                
                if (!fileInput.files.length) {
                    alert('请选择要上传的文件');
                    return;
                }
                
                const file = fileInput.files[0];
                // 这里应该是文件上传的API调用
                console.log('上传文件:', {
                    file: file.name,
                    description: description
                });
                
                // 添加文件到列表
                addFileToList(file.name, description);
                
                // 关闭模态框
                document.getElementById('uploadModal').style.display = 'none';
                
                // 清空表单
                fileInput.value = '';
                document.getElementById('fileDescription').value = '';
                
                // 显示成功提示
                alert('文件上传成功！');
            });

            // 添加文件到列表
            function addFileToList(fileName, description) {
                const fileList = document.querySelector('.file-list');
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item flex items-center justify-between p-2 rounded-md bg-white';
                
                // 根据文件类型选择图标
                const fileIcon = getFileIcon(fileName);
                
                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${fileIcon} mr-2"></i>
                        <span class="text-sm text-gray-700">${fileName}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="text-blue-600 hover:text-blue-700" onclick="previewFile('${fileName}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="text-blue-600 hover:text-blue-700" onclick="downloadFile('${fileName}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-700" onclick="confirmDeleteFile('${fileName}', this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // 如果列表为空，移除提示
                if (fileList.querySelector('.text-center')) {
                    fileList.innerHTML = '';
                }
                
                fileList.appendChild(fileItem);
                
                // 检查环节状态
                checkStepStatus(fileList.closest('.timeline-item'));
            }

            // 获取文件图标
            function getFileIcon(fileName) {
                const extension = fileName.split('.').pop().toLowerCase();
                switch (extension) {
                    case 'pdf':
                        return 'fa-file-pdf text-red-500';
                    case 'doc':
                    case 'docx':
                        return 'fa-file-word text-blue-500';
                    case 'xls':
                    case 'xlsx':
                        return 'fa-file-excel text-green-500';
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                        return 'fa-file-image text-yellow-500';
                    default:
                        return 'fa-file text-gray-500';
                }
            }

            // 预览文件
            function previewFile(fileName) {
                // 这里应该是文件预览的实现
                console.log('预览文件:', fileName);
                alert(`预览文件: ${fileName}`);
            }

            // 下载文件
            function downloadFile(fileName) {
                // 这里应该是文件下载的实现
                console.log('下载文件:', fileName);
                alert(`下载文件: ${fileName}`);
            }

            // 文件删除相关功能
            function confirmDeleteFile(fileName, button) {
                const modal = document.getElementById('deleteFileModal');
                document.getElementById('fileNameToDelete').textContent = fileName;
                modal.style.display = 'block';
                
                // 存储当前文件项，用于删除后更新UI
                modal.dataset.fileItem = button.closest('.file-item');
            }

            // 关闭删除模态框
            document.getElementById('closeDeleteModal').addEventListener('click', function() {
                document.getElementById('deleteFileModal').style.display = 'none';
            });

            document.getElementById('cancelDelete').addEventListener('click', function() {
                document.getElementById('deleteFileModal').style.display = 'none';
            });

            // 确认删除文件
            document.getElementById('confirmDelete').addEventListener('click', function() {
                const modal = document.getElementById('deleteFileModal');
                const fileItem = modal.dataset.fileItem;
                
                // 这里应该是文件删除的API调用
                console.log('删除文件:', fileItem.querySelector('.text-sm').textContent);
                
                // 从列表中移除文件项
                fileItem.remove();
                
                // 如果列表为空，显示提示
                const fileList = fileItem.closest('.file-list');
                if (fileList.children.length === 0) {
                    fileList.innerHTML = `
                        <div class="text-center py-4 text-sm text-gray-500">
                            <i class="fas fa-folder-open mb-2"></i>
                            <p>暂无文件</p>
                        </div>
                    `;
                }
                
                // 检查环节状态
                checkStepStatus(fileList.closest('.timeline-item'));
                
                // 关闭模态框
                modal.style.display = 'none';
            });

            // 检查环节状态
            function checkStepStatus(stepElement) {
                const now = new Date();
                const startTime = new Date(stepElement.dataset.startTime);
                const isCurrentTime = now >= startTime;
                
                // 检查是否是第一个环节或上一环节已完成
                const prevStep = stepElement.previousElementSibling;
                const isPrevStepCompleted = !prevStep || prevStep.classList.contains('completed');
                
                // 如果当前时间已到且上一环节已完成，则标记为进行中
                if (isCurrentTime && isPrevStepCompleted) {
                    stepElement.classList.remove('completed');
                    stepElement.classList.add('current');
                    
                    // 更新环节内容
                    const stepContent = stepElement.querySelector('.bg-gray-50, .bg-green-50');
                    stepContent.classList.remove('bg-gray-50', 'bg-green-50');
                    stepContent.classList.add('bg-blue-50');
                    
                    // 更新状态标签
                    const statusLabel = stepContent.querySelector('.text-gray-500, .text-green-600');
                    statusLabel.classList.remove('text-gray-500', 'text-green-600');
                    statusLabel.classList.add('text-blue-600');
                    statusLabel.textContent = '进行中';
                    
                    // 更新图标颜色
                    const icon = stepContent.querySelector('.text-gray-400, .text-green-500');
                    icon.classList.remove('text-gray-400', 'text-green-500');
                    icon.classList.add('text-blue-500');
                    
                    // 添加完成任务按钮
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'mt-4';
                    
                    const button = document.createElement('button');
                    button.className = 'inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700';
                    button.innerHTML = '<i class="fas fa-check mr-2"></i>完成任务';
                    
                    button.addEventListener('click', function() {
                        completeCurrentStep(stepElement);
                    });
                    
                    buttonContainer.appendChild(button);
                    stepContent.appendChild(buttonContainer);
                }
                
                // 更新进度
                updateProgress();
                
                // 检查流程完成状态
                checkProcessCompletion();
            }

            // 修改邮件发送相关功能
            document.getElementById('scheduleSend').addEventListener('change', function() {
                const scheduleTimeContainer = document.getElementById('scheduleTimeContainer');
                scheduleTimeContainer.classList.toggle('hidden', !this.checked);
            });

            document.getElementById('sendNow').addEventListener('change', function() {
                const scheduleTimeContainer = document.getElementById('scheduleTimeContainer');
                scheduleTimeContainer.classList.toggle('hidden', this.checked);
            });
        });
    </script>
</body>
</html> 